angular.module("ngSecured",["ui.router","jmdobry.angular-cache"]).run(["ngSecured",function(){}]),angular.module("ngSecured").constant("ngSecured.cacheOptions",{timeout:{FOREVER:"forever"},location:{LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},cacheKeys:{MAIN_CACHE:"ngSecuredCache",IS_LOGGED_IN:"isLoggedIn",ROLES:"roles"}}),function(a){var b="private__ngSecured";a.module("ngSecured").constant("ngSecured.defaultStateNames",{BASE_STATE:b,NOT_AUTHENTICATED:b+".notAuthenticated",NOT_AUTHORIZED:b+".notAuthorized"})}(angular),angular.module("ngSecured").directive("asRole",["ngSecured","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){function h(a){var b=a[0],c=a[a.length-1];if(b===c)return angular.element(b);var d=b,e=[d];do{if(d=d.nextSibling,!d)break;e.push(d)}while(d!==c);return angular.element(e)}function i(){a.includesRole(l)?k||(k=c.$new(),g(k,function(a){a[a.length++]=document.createComment(" end asRole: "+e.asRole+" "),j={clone:a},b.enter(a,d.parent(),d)})):(j&&(b.leave(h(j.clone)),j=null),k&&(k.$destroy(),k=null))}var j,k,l;c.$watch(function(){return e.asRole},function(a){l=a,i()}),c.$watch(function(){return a.getRoles()},i)}}}]),angular.module("ngSecured").provider("ngSecured",["$stateProvider","ngSecured.defaultStateNames","ngSecured.cacheOptions","$httpProvider",function(a,b,c,d){function e(a,b){f=a,g=b}var f,g,h={loginState:b.NOT_AUTHENTICATED,unAuthorizedState:b.NOT_AUTHORIZED,postLoginState:b.NOT_AUTHENTICATED,postLogoutState:b.NOT_AUTHENTICATED,fetchRoles:void 0,login:void 0,isAuthenticated:void 0,cache:{timeout:c.timeout.FOREVER,location:c.location.LOCAL_STORAGE},reloginOnHttpStatus:void 0};a.state(b.BASE_STATE,{}),a.state(b.NOT_AUTHENTICATED,{views:{"@":{template:"please login to see this page."}}}),a.state(b.NOT_AUTHORIZED,{views:{"@":{template:"You are not authorized to see this page."}}}),this.secure=function(a){angular.extend(h,a)},function(){d.interceptors.push(["$injector","$q",function(a,b){return{responseError:function(c){function d(){e(g.current.name,g.params),g.go(h.loginState)}var f=h.reloginOnHttpStatus;if(f){var g=a.get(["$state"]);angular.isNumber(f)&&c.status===f?d():angular.isArray(f)&&-1!==f.indexOf(c.status)&&d()}return b.reject(c)}}}])}(),this.$get=["$rootScope","$state","$q","$injector","$angularCacheFactory",function(a,b,d,i,j){function k(){f=h.postLoginState,h.cache&&(v=j(c.cacheKeys.MAIN_CACHE,{storageMode:h.cache.location}))}function l(){f&&b.go(f,g)}function m(){if(!h.fetchRoles)throw new Error("fetchRoles is not defined");var a=i.invoke(h.fetchRoles);return d.when(a).then(function(a){return a&&p(a),a})}function n(){if(h.isAuthenticated)return i.invoke(h.isAuthenticated);if(h.cache&&v){var a=v.get(c.cacheKeys.IS_LOGGED_IN);return!!a}return!1}function o(){return!u&&h.cache&&(u=v.get(c.cacheKeys.ROLES)),u}function p(a){u=angular.isString(a)?[a]:angular.isArray(a)?a:void 0,u&&h.cache&&v.put(c.cacheKeys.ROLES,u)}function q(a){return u&&-1!==u.indexOf(a)?!0:!1}function r(a){if(h.login){var b=d.when(i.invoke(h.login,h,{credentials:a}));return b.then(function(){h.cache&&v.put(c.cacheKeys.IS_LOGGED_IN,!0),h.fetchRoles?m().then(function(){l()}):l()}),b}throw new Error("login function must be configured")}function s(){return angular.copy(h.cache)}function t(a){var c;return v&&v.removeAll(),h.logout&&(c=i.invoke(h.logout)),b.go(a?h.loginState:h.postLogoutState),d.when(c)}var u,v;return k(),a.$on("$stateChangeStart",function(a,c,d){c.secured&&(n()?c.secured.hasOwnProperty("role")&&(!u||u.indexOf(c.secured.role))&&(a.preventDefault(),b.go(h.unAuthorizedState)):(a.preventDefault(),e(c.name,d),b.go(h.loginState)))}),{_initVars:k,_getCacheConfig:s,loggingIn:r,fetchingRoles:m,isAuthenticated:n,setRoles:p,getRoles:o,includesRole:q,loggingOut:t}}]}]);